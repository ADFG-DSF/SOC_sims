---
title: "Chronic Inability"
author: "Adam Reimer"
format:
  html:
    embed-resources: true
editor: visual
---

```{r include = FALSE}
# Packages
packs <- c("tidyverse", "ggforce", "RcppRoll", "flextable", "zoo")
lapply(packs, require, character.only = TRUE)

# source functions
function_files <- list.files(path="..\\functions")
lapply(function_files, function(x) source(paste0("..\\functions\\", x)))

rep_scenarios <- readRDS("..//rep_scenarios_ChronicInability.rds")

# SOC listings ---------------------------------------------------------
# function to calculate SOC status
# window: # of years under consideration when evaluating "chronic inability"
# misses_in: # of missed in window that result in a SOC listing
# makes_out: # of makes in window that result in a SOC delisting.
# originally written to work inside a list-column although it seems to work in groups too.
get_SOC2 <- function(x, misses_in, makes_out, window = 5){
  SOC <- character()
  SOC[1:(window - 1)] <- NA
  from_noconcern <- function(x){
    if(sum(x, na.rm = TRUE) >= misses_in){"SOC"} else("No concern")
  }
  from_SOC <- function(x){
    if(sum(x, na.rm = TRUE) > (window - makes_out)){"SOC"} else("No concern")
  }
  if(length(x) >= window){
    for(i in window:length(x)){
      SOC[i] <- switch(as.character(SOC[i-1]),
                       'NA' = from_noconcern(x[((i-1)-(window - 1)):(i-1)]),
                       "No concern" = from_noconcern(x[((i-1)-(window - 1)):(i-1)]),
                       "SOC" = from_SOC(x[((i-1)-(window - 1)):(i-1)]))
    }
  }
  out <- ifelse(SOC == "SOC", TRUE, ifelse(SOC == "No concern", FALSE, NA))
  
  return(out)
}

# SOC status for different definitions of chronic inability
# N### naming convention is {misses_in}{makes_out}{window}
dat_SOC <- 
  rep_scenarios %>%
  filter(scenario != 64, rep != 17) %>%
  filter(pct_lb == 1) %>%
  mutate(data_trunc = map(data, function(x) x[x$sim > 30, c("sim", "N", "lb_goal")])) %>%
  unnest(data_trunc) %>%
  select(scenario:pct_lb, power, sim:lb_goal) %>%
  filter(sim < 100 | sim >= 130) %>%
  mutate(regime = ifelse(sim < 100, "Historic", ifelse(sim >= 130, "Low", NA))) %>%
  group_by(scenario, regime, rep) %>%
  mutate(
    roll5 = rollmean(N, k = 5, align = "right", fill = NA),
    SOC_roll5 = roll5 < lb_goal, #rolling mean to account for the size of the miss/make
    mean_roll5 = mean(SOC_roll5, na.rm = TRUE),
    lb_N = N < lb_goal,
    SOC_N155 = get_SOC2(lb_N, 1, 5, 5), #most sensitive
    mean_155 = mean(SOC_N155, na.rm = TRUE),
    SOC_N445 = get_SOC2(lb_N, 4, 4, 5), #ADF&G most common?
    mean_445 = mean(SOC_N445, na.rm = TRUE),
    SOC_N515 = get_SOC2(lb_N, 5, 1, 5), #lease sensitive
    mean_515 = mean(SOC_N515, na.rm = TRUE)) %>%
  group_by(scenario, rep)
```

### Chronic Inability Hypothesis Test {#sec-soc-designations}

Having seen a time series of run sizes and escapements under each productivity regime lets take a look at the frequency of SOC designations under each regime (@fig-baseSeq). The results are generally similar to what one might predict... SOC designations are rare under historical productivity regimes and become the expectation under low productivity regimes. One way to interpret these results might be to consider them in light of a hypothesis test where $H_0= \textrm{stock productivity is at it's historic average}$. In that light the risk of a false negative (declaring a stock as a stock of concern when productivity is near it's historic average) is negligible while the power of the test (ability to detect low productivity when it occurs is \~$50$% or less. If this interpretation is deemed valid it suggests that recommending a SOC definition when the criteria has been satisfied in 4 of the last 5 years and recommending desisting when the criteria has not been met in 4 of the last 5 years is a weak indicator of an extreme reduction in stock productivity.

My observation would be that ADF&G staff are in general reluctant to make SOC recommendations and these results suggest we might consider being less so. While this technique suggests a mechanism to test other interpretations of *chronic inability* (x of y years, y consecutive years, rolling mean escapement) as perhaps more powerful indicators of low contemporary productivity I though it was best to postpone that work until staff have an opportunity to weigh in.

```{r echo = FALSE, warning = FALSE}
#| label: fig-Ha
#| fig.height: 6
#| fig.width: 10
#| fig.cap: "Percent of simulated years classified as a stock of concern relative to the productivity regime assumed for several chronic inability criteria. One can imagine these results as a scientific hypotheses test where the null hypotheses is that the stock recruit data was generated during the historic productivity regime. Then the median values for the historic and low productivity regimes represent the probability of Type I and Type II errors, respectively."


# demonstrate regime and SOC entry/exit criteria differences for one group of scenarios
# Hypothesis test for 445
# NULL: High productivity
# false positives (Look at Historic regime): non-existent, i.e. alpha = 0
# false negatives  (Look at Low regime): 
#     gamma=1: Fail to reject Null often, beta ~ .35,  
#     gamma>1: Reject null occasionally in "safest" situation, beta > .75
# Entry/Exit criteria: would need a very sensitive test to get high power w Ricker 
dat_SOC %>%
  filter(lnalpha_1 == 1.5, sigma == 0.5, phi == 0) %>%
  pivot_longer(dplyr::starts_with("mean_"), names_to = "Chronic_I", values_to = "pct_SOC") %>%
  ggplot(aes(x = Chronic_I, y  = pct_SOC, color = regime)) + 
  geom_boxplot() +
  guides(x =  guide_axis(angle = -20)) +
  scale_color_discrete(name = "Regime (statistic)", 
                     labels = c("Historic" = "Historic (\u03B1)", "Low" = "Low (\u03B2)")) +
  labs(x = "Chronic Inability Criteria",
       y = "Probability") +
  facet_grid(paste0("%MSY: ", pct_MSY) ~ paste0("\u03B3: ", gamma))
```

### Rebuilding

```{r include = FALSE}
# Look for sensitivity wrt 445 and roll5 across SR parameter combinations
# pct_MSY, phi and gamma
# phi has little effect
dat_SOC %>%
  filter(regime == "Low", sigma == 0.5, lnalpha_1 == 1.5) %>%
  pivot_longer(dplyr::starts_with("mean_"), names_to = "Chronic_I", values_to = "pct_SOC") %>%
  filter(Chronic_I %in% c("mean_445", "mean_roll5")) %>%
  ggplot(aes(x = Chronic_I, y  = pct_SOC, color = as.character(phi))) + 
  geom_boxplot() +
  labs(title = paste0("ln(\u03B1): ", 1.5, ", \u03C3: ", 0.5)) +
  facet_grid(paste0("%MSY: ", pct_MSY) ~ paste0("\u03B3: ", gamma))
```
